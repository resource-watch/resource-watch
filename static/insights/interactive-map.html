<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Farms to feel squeeze as competition for water increases</title>
  <link rel="stylesheet" media="screen" href="https://fonts.googleapis.com/css?family=Lato:400,300,700">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" media="all" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css">
  <link rel="stylesheet" href="https://vizzuality.github.io/WRW-Prototype/styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.9/slick.min.css">
  <style>
    body {
      display: block;
    }
    .story--breadcrumbs li a {
      color: #3bb2d0;
    }
    #content {min-height: 700px;}
    /* Custom styles for input range */
    input[type=range] {
      -webkit-appearance: none; /* Hides the slider so that custom slider can be made */

      display: flex;
      width: calc(100% - 25px);

      margin: 25px auto 0;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
    }

    input[type=range]:focus {
      outline: none; /* Removes the blue border. You should probably do some kind of focus styling for accessibility reasons though. */
    }

    input[type=range]::-ms-track {
      width: 100%;
      cursor: pointer;
      background: transparent; /* Hides the slider so custom styles can be added */
      border-color: transparent;
      color: transparent;
    }

    input[type=range]::-webkit-slider-runnable-track {
      position: relative;
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: #c32d7b;
      border-radius: 4px;
    }

    input[type=range]:focus::-webkit-slider-runnable-track {
      background: #c32d7b;
    }

    input[type=range]::-moz-range-track {
      position: relative;
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: #c32d7b;
      border-radius: 4px;
    }

    input[type=range]::-ms-track {
      width: 100%;
      height: 8.4px;
      cursor: pointer;
      background: transparent;
      border-color: transparent;
      border-width: 16px 0;
      color: transparent;
    }
    input[type=range]::-ms-fill-lower {
      background: #2a6495;
      border: 0.2px solid #010101;
      border-radius: 2.6px;
      box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
    }
    input[type=range]:focus::-ms-fill-lower {
      background: #3071a9;
    }
    input[type=range]::-ms-fill-upper {
      background: #3071a9;
      border: 0.2px solid #010101;
      border-radius: 2.6px;
      box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
    }
    input[type=range]:focus::-ms-fill-upper {
      background: #367ebd;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;

      position: absolute;
      top: 1px;


      width: 18px;
      height: 18px;

      background: #fff;
      border-radius: 100%;
      box-shadow: 0 1px 4px rgba(0,0,0,.3);


      transform: translate(0,-50%);

      cursor: grab;
    }

    input[type=range]::-moz-range-thumb {
      position: absolute;
      top: 1px;


      width: 18px;
      height: 18px;

      background: #fff;
      border-radius: 100%;
      box-shadow: 0 1px 4px rgba(0,0,0,.3);


      transform: translate(0,0);

      cursor: grab;
    }

  </style>
</head>
<body>

<div class="is-default">

    <svg style="display:none" class="is-hidden">
        <!-- Star-->
        <symbol id="icon-star" viewBox="0 0 1092 1024">
            <title>star</title>
            <path d="M546.133 779.605l-361.135 263.588 139.090-424.913-362.284-262.007 447.098 0.977 137.231-425.517 137.231 425.517 447.098-0.977-362.284 262.007 139.090 424.913z" class="path1"></path>
        </symbol>
        <!-- Options-->
        <symbol id="icon-cog" viewBox="0 0 1024 1024">
            <title>cog</title>
            <path d="M914.625 505.976c0-63.090 38.828-112.893 97.328-147.131-10.529-35.226-24.504-68.957-41.671-100.713-65.596 17.155-118.676-8.541-163.298-53.152-44.622-44.634-58.284-97.726-41.117-163.31-31.756-17.179-65.488-31.142-100.713-41.671-34.238 58.501-96.075 97.34-159.178 97.34s-124.928-38.84-159.178-97.34c-35.226 10.517-68.957 24.492-100.713 41.659 17.155 65.584 3.506 118.676-41.117 163.322-44.622 44.622-97.726 70.307-163.298 53.164-17.179 31.744-31.142 65.476-41.671 100.701 58.488 34.238 97.328 84.040 97.328 147.131s-38.84 124.94-97.328 159.178c10.529 35.226 24.492 68.957 41.671 100.713 65.584-17.155 118.676-3.506 163.298 41.117 44.61 44.622 58.272 97.726 41.117 163.298 31.756 17.179 65.488 31.154 100.725 41.671 34.25-58.501 96.063-97.328 159.166-97.328s124.94 38.828 159.178 97.328c35.226-10.529 68.957-24.492 100.725-41.683-17.155-65.56-3.518-118.664 41.105-163.286s97.714-70.319 163.298-53.164c17.167-31.756 31.142-65.488 41.671-100.713-58.501-34.238-97.328-84.040-97.328-147.131v0zM505.976 726.028c-121.519 0-220.040-98.521-220.040-220.052s98.521-220.040 220.040-220.040c121.531 0 220.027 98.509 220.027 220.040s-98.497 220.052-220.027 220.052v0z"
                class="path1"></path>
        </symbol>
        <!-- Share-->
        <symbol id="icon-share" viewBox="0 0 904 1024">
            <title>share</title>
            <path d="M725.054 669.281c-38.339 0-73.543 13.029-101.753 34.713l-291.093-174.649c1.472-8.935 2.432-18.037 2.432-27.385 0-9.359-0.959-18.45-2.432-27.385l291.093-174.649c28.21 21.685 63.414 34.713 101.753 34.713 92.394 0 167.32-74.926 167.32-167.32s-74.926-167.32-167.32-167.32c-92.405 0-167.32 74.926-167.32 167.32 0 9.348 0.959 18.45 2.421 27.385l-291.081 174.649c-28.221-21.685-63.426-34.713-101.753-34.713-92.405 0-167.32 74.926-167.32 167.32s74.915 167.32 167.32 167.32c38.327 0 73.532-13.029 101.753-34.713l291.081 174.649c-1.461 8.935-2.421 18.026-2.421 27.385 0 92.394 74.915 167.32 167.32 167.32 92.394 0 167.32-74.926 167.32-167.32s-74.926-167.32-167.32-167.32z"
                class="path1"></path>
        </symbol>
        <!-- Info-->
        <symbol id="icon-info" viewBox="0 0 1024 1024">
            <title>info</title>
            <path d="M636.518 0c68.608 0 102.912 46.797 102.912 100.25 0 66.765-59.597 128.563-137.114 128.563-65.024 0-102.912-38.4-101.12-101.837 0-53.504 45.056-126.976 135.322-126.976zM425.421 1024c-54.17 0-93.85-33.382-55.962-180.378l62.157-260.659c10.803-41.728 12.595-58.47 0-58.47-16.282 0-86.528 28.826-128.102 57.242l-27.034-45.107c131.738-111.923 283.238-177.51 348.211-177.51 54.118 0 63.078 65.126 36.096 165.325l-71.219 274.022c-12.595 48.435-7.219 65.126 5.376 65.126 16.282 0 69.478-20.122 121.805-61.85l30.72 41.728c-128.051 130.355-267.93 180.531-322.048 180.531z"
                class="path1"></path>
        </symbol>
        <!-- Cross-->
        <symbol id="icon-cross" viewBox="0 0 1024 1024">
            <title>cross</title>
            <path d="M734.669 673.382l-141.21-161.382 141.21-161.382c24.013-24.013 24.013-62.925 0-86.886-24.013-23.962-62.925-23.962-86.886 0l-135.782 155.187-135.731-155.136c-24.013-24.013-62.925-24.013-86.886 0-23.962 24.013-23.962 62.925 0 86.886l141.158 161.331-141.21 161.382c-23.962 24.013-23.962 62.822 0 86.784 24.013 24.013 62.925 24.013 86.886 0l135.782-155.085 135.731 155.085c24.013 24.013 62.925 24.013 86.886 0s24.013-62.771 0.051-86.784z"
                class="path1"></path>
        </symbol>
        <!-- Alt logo-->
        <symbol id="icon-logo" viewBox="0 0 6220 1024">
            <title>logo</title>
            <path fill="#393F44" d="M1628.835 499.686c14.791-19.824 22.193-43.907 22.193-72.238 0-23.428-4.087-42.975-12.223-58.652-8.174-15.665-19.169-28.129-33.011-37.392-13.842-9.25-29.949-16.396-48.346-20.366s-37.832-6.478-58.316-6.478h-150.011v403.28h88.569v-163.832h38.135l84.179 163.832h106.384l-102.398-169.945c28.456-5.28 50.054-18.387 64.845-38.211v0zM1551.768 452.376c-4.745 6.049-10.73 10.473-17.916 13.321-7.225 2.823-15.272 2.899-24.192 3.466s-17.347-0.769-25.305-0.769h-46.663v-88.217h52.357c7.959 0 16.107 0.693 24.445 1.815 8.351 1.134 15.753 3.377 22.193 6.579 6.44 3.226 11.754 7.877 15.93 13.913 4.163 6.049 6.25 14.178 6.25 24.373 0 10.977-2.366 19.483-7.098 25.52zM1791.967 544.009h177.138v-88.217h-177.138v-63.012h177.138v-88.217h-265.707v403.28h278.36v-88.217h-189.791v-75.615zM2252.007 495.439c-13.842-8.305-28.722-14.732-44.651-19.269s-30.822-9.061-44.651-13.598c-13.855-4.537-25.318-9.994-34.415-16.434-9.11-6.415-13.652-15.665-13.652-27.763 0-7.549 1.885-13.976 5.681-19.269 3.796-5.268 8.73-9.527 14.791-12.741 6.073-3.201 12.514-5.57 19.346-7.083 6.82-1.5 13.462-2.256 19.915-2.256 10.995 0 22.648 2.168 34.972 6.503 12.324 4.348 22.092 11.052 29.304 20.114l60.86-66.289c-17.056-15.098-36.212-25.873-57.456-32.288-21.244-6.427-43.234-9.641-65.984-9.641-19.713 0-38.869 2.747-57.456 8.217-18.574 5.482-34.972 13.699-49.194 24.638-14.222 10.977-25.609 24.575-34.137 40.807-8.528 16.245-12.792 35.136-12.792 56.661 0 22.281 4.631 40.227 13.931 53.825 9.287 13.598 20.953 24.55 34.985 32.867 14.019 8.305 29.202 14.921 45.512 19.824 16.297 4.915 31.467 9.83 45.499 14.732s25.698 10.863 34.985 17.845c9.287 7.007 13.943 16.522 13.943 28.608 0 7.196-1.809 13.422-5.403 18.715-3.606 5.293-8.338 9.616-14.222 13.018s-12.526 5.961-19.915 7.65c-7.389 1.701-14.702 2.558-21.902 2.558-14.791 0-29.114-3.302-42.943-9.931-13.842-6.591-25.318-15.942-34.415-28.028l-63.137 69.112c19.333 17.757 40.185 30.599 62.568 38.538 22.383 7.927 46.638 11.897 72.816 11.897 20.839 0 40.678-2.647 59.442-7.94 18.764-5.28 35.263-13.396 49.485-24.348s25.508-24.739 33.846-41.374c8.338-16.623 12.514-36.068 12.514-58.35 0-23.428-4.542-42.118-13.652-56.106-9.097-13.964-20.573-25.117-34.415-33.422zM2702.254 352.375c-19.333-18.324-42.273-32.388-68.818-42.218-26.558-9.817-55.571-14.732-87.038-14.732-31.48 0-60.493 4.915-87.038 14.732-26.558 9.83-49.485 23.894-68.831 42.218s-34.415 40.504-45.233 66.579c-10.793 26.049-16.208 55.149-16.208 87.247 0 32.111 5.415 61.198 16.208 87.247 10.818 26.075 25.887 48.268 45.233 66.592s42.273 32.388 68.831 42.206c26.545 9.817 55.558 14.732 87.038 14.732 31.467 0 60.48-4.915 87.038-14.732 26.545-9.817 49.485-23.882 68.818-42.206 19.359-18.324 34.428-40.517 45.246-66.592 10.793-26.049 16.208-55.136 16.208-87.247 0-32.099-5.415-61.198-16.208-87.247-10.818-26.075-25.887-48.255-45.246-66.579zM2662.727 558.048c-5.884 15.678-14.323 29.276-25.318 40.794s-24.179 20.492-39.54 26.919c-15.36 6.427-32.517 9.628-51.471 9.628-18.966 0-36.124-3.201-51.484-9.628s-28.532-15.4-39.54-26.919c-10.995-11.519-19.435-25.117-25.305-40.794-5.884-15.665-8.819-32.943-8.819-51.847 0-18.5 2.935-35.69 8.819-51.557 5.871-15.867 14.31-29.553 25.305-41.084 11.008-11.519 24.179-20.479 39.54-26.919 15.36-6.415 32.517-9.616 51.484-9.616 18.954 0 36.111 3.201 51.471 9.616 15.36 6.44 28.545 15.4 39.54 26.919 10.995 11.531 19.435 25.218 25.318 41.084 5.871 15.867 8.819 33.056 8.819 51.557 0 18.904-2.948 36.182-8.819 51.847zM3057.239 548.697c0 12.464-0.86 23.995-4.846 34.569s-9.009 19.736-16.221 27.473c-7.199 7.751-15.462 13.787-25.318 18.135s-20.535 6.515-32.277 6.515c-11.754 0-22.598-2.168-32.644-6.515s-18.637-10.384-25.849-18.135c-7.199-7.738-15.095-16.9-19.068-27.473-3.986-10.573-8.262-22.105-8.262-34.569v-244.136h-88.569v247.538c0 23.794 5.82 45.709 13.020 65.722 7.212 20.025 19.042 37.404 33.264 52.137s32.505 26.251 53.736 34.556c21.244 8.305 46.17 12.464 74.233 12.464 27.671 0 52.281-4.159 73.525-12.464 21.231-8.305 39.034-19.824 53.268-34.556 14.222-14.732 23.749-32.111 30.949-52.137 7.199-20.013 9.629-41.929 9.629-65.722v-247.538h-88.569v244.136zM3500.362 499.686c14.778-19.824 22.18-43.907 22.18-72.238 0-23.428-4.087-42.975-12.223-58.652-8.174-15.665-19.169-28.129-33.011-37.392-13.842-9.25-29.949-16.396-48.346-20.366s-37.819-6.478-58.316-6.478h-161.575v403.28h88.569v-163.832h49.7l84.179 163.832h106.384l-102.398-169.945c28.456-5.28 50.067-18.387 64.858-38.211zM3423.282 452.376c-4.745 6.049-10.73 10.473-17.916 13.321-7.225 2.823-15.272 2.899-24.179 3.466-8.92 0.567-17.36-0.769-25.318-0.769h-58.228v-88.217h63.922c7.959 0 16.107 0.693 24.445 1.815 8.351 1.134 15.753 3.377 22.193 6.579 6.44 3.226 11.754 7.877 15.93 13.913 4.163 6.049 6.25 14.178 6.25 24.373 0 10.977-2.366 19.483-7.098 25.52zM3800.712 624.047c-14.032 7.574-30.151 11.342-48.346 11.342-15.93 0-30.822-3.201-44.664-9.628s-25.887-15.4-36.111-26.919c-10.249-11.519-18.308-25.117-24.179-40.794-5.884-15.665-8.819-32.943-8.819-51.847 0-18.5 2.935-35.69 8.819-51.557 5.871-15.867 14.019-29.553 24.458-41.084 10.426-11.519 22.75-20.479 36.971-26.919 14.222-6.415 29.671-9.616 46.36-9.616s31.379 2.823 44.095 8.481c12.691 5.684 23.408 13.8 32.138 24.373l68.261-55.527c-8.73-10.952-18.587-20.202-29.582-27.763-10.995-7.549-22.459-13.611-34.415-18.135-11.944-4.524-24.091-7.839-36.402-9.918-12.324-2.067-24.179-3.113-35.554-3.113-31.48 0-60.493 4.915-87.038 14.732-26.558 9.83-49.485 23.894-68.831 42.218s-34.415 40.504-45.233 66.579c-10.793 26.049-16.208 55.149-16.208 87.247 0 32.111 5.415 61.198 16.208 87.247 10.818 26.075 25.887 48.268 45.233 66.592s42.273 32.388 68.831 42.206c26.545 9.817 55.558 14.732 87.038 14.732 27.671 0 54.609-5.671 80.775-16.988 26.166-11.342 47.789-28.898 64.858-52.704l-73.955-54.959c-9.11 13.598-20.675 24.172-34.706 31.72zM4031.498 544.009h177.138v-88.217h-177.138v-63.012h189.791v-88.217h-278.36v403.28h291.013v-88.217h-202.443v-75.615zM4762.635 304.561l-100.108 352.87h-1.139l-101.829-352.87h-47.789l-101.816 352.87h-1.139l-100.121-352.87h-38.679l117.177 403.28h46.081l101.829-352.87h1.139l101.829 352.87h46.069l117.189-403.28h-38.692zM4967.419 304.561l-175.784 403.28h39.261l45.499-113.422h213.325l43.804 113.422h42.096l-169.521-403.28h-38.679zM4891.187 569.214l93.858-219.825 91.024 219.825h-184.882zM5170.242 342.369h139.18v365.472h37.958v-365.472h139.18v-37.807h-316.318v37.807zM5805.333 648.698c-9.477 7.738-19.435 14.165-29.86 19.269s-21.143 8.885-32.138 11.33c-10.995 2.457-21.611 3.68-31.86 3.68-26.166 0-49.763-4.524-70.817-13.598-21.041-9.061-38.97-21.525-53.749-37.392-14.791-15.867-26.178-34.556-34.15-56.094-7.959-21.525-11.944-44.764-11.944-69.692s3.986-48.167 11.944-69.692c7.971-21.538 19.359-40.227 34.15-56.094 14.778-15.867 32.707-28.33 53.749-37.404 21.054-9.049 44.651-13.598 70.817-13.598 20.472 0 40.476 4.36 60.024 13.031 19.51 8.708 35.541 22.495 48.055 41.374l30.721-25.507c-17.828-22.659-38.591-38.803-62.289-48.444-23.699-9.628-49.194-14.442-76.511-14.442-30.708 0-58.873 5.293-84.47 15.867-25.596 10.586-47.498 25.218-65.706 43.907-18.195 18.702-32.416 40.895-42.665 66.579-10.236 25.684-15.36 53.825-15.36 84.424 0 30.586 5.124 58.841 15.36 84.701 10.249 25.886 24.47 48.167 42.665 66.869 18.207 18.69 40.109 33.245 65.706 43.63 25.596 10.372 53.761 15.577 84.47 15.577 29.582 0 57.076-5.671 82.496-16.988 25.394-11.342 47.777-30.032 67.11-56.106l-30.708-23.226c-7.199 10.964-15.563 20.303-25.040 28.041zM6182.46 304.561v176.435h-227.749v-176.435h-37.958v403.28h37.958v-189.037h227.749v189.037h37.958v-403.28h-37.958z"
                class="path1"></path>
            <path fill="#B6216E" d="M329.333 184.579l-329.333 328.050 232.487 231.565 329.357-328.050-232.511-231.565z" class="path2"></path>
            <path fill="#B6216E" d="M609.354 364.455l133.083-132.54-228.103-227.212-133.083 132.54 228.103 227.212z" class="path3"></path>
            <path fill="#B6216E" d="M694.002 844.124l329.357-328.050-232.487-231.565-329.357 328.050 232.487 231.565z" class="path4"></path>
            <path fill="#B6216E" d="M413.99 664.248l-133.068 132.54 228.117 227.212 133.068-132.54-228.117-227.212z" class="path5"></path>
        </symbol>
    </svg>

    <!-- Content -->
    <div id="content" class="insights--interactive-map">
      <div id="js-map" class="insights--interactive-map-container"></div>

      <div class="insights--interactive-scenario-legend">
        <h2>Farms to feel squeeze as competition for water increases</h2>
        <p>Farmers are facing increasing competition for water from the growth of cities and industrialization, and are likely to see big changes in rainfall because of climate change. This map shows the worldâ€™s irrigated farmland, color-coded by the rate at which water stress, a measure of competition for water, is likely to change. In total, 35 percent of irrigated farmland is likely to see substantial increases in water stress by 2040.</p>
        <hr>
        <input id="year-range" name="year-range" type="range">
        <div class="slider-values"><span>2020</span><span>2030</span><span>2040</span></div>
      </div>
      <div class="insights--interactive-layers-legend">
        <h3>Layers</h3>
        <ul class="explore--map-legend-layers">
          <li>Change in water stress<span class="onoffswitch"><span></span></span></li>
        </ul>
        <div class="chloropleth"><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
          <div><span>> 2.8x increase</span><span>> 2.8x decrease</span></div>
        </div>
        <ul class="explore--map-legend-controls insights--interactive-map-legend-controls">
          <li><a href="#">Open in data map</a></li>
          <li><a class="is-disabled"><i class="fa fa-cog"></i></a></li>
          <li><a class="is-disabled"><i class="fa fa-share-alt"></i></a></li>
        </ul>
      </div>
    </div>
</div>

<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.2/backbone.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.20/require.js"></script>
<script>

  var infowindowTPL = '<div class="insights--interactive-map-infowindow"> \
    <a href="#close" class="quit-button close"></a> \
      <h2>{{content.data.name}}</h2> \
      <div class="insights--interactive-map-infowindow-data"> \
        <h3>Agricultural GDB</h3> \
        <span class="value">{{#content.data.avg}}{{content.data.avg}}{{/content.data.avg}}{{^content.data.avg}}-{{/content.data.avg}}%</span> \
      </div> \
      <div class="insights--interactive-map-infowindow-data"> \
        <h3>Water Stress Prevision</h3> \
        <div class="value">{{#content.data.prev_%year%_t}}{{content.data.prev_%year%_t}}{{/content.data.prev_%year%_t}}{{^content.data.prev_%year%_t}}-{{/content.data.prev_%year%_t}}</div> \
      </div> \
      <div class="insights--interactive-map-infowindow-data" \
        <h3>Crop production</h3> \
        <div class="value">{{#content.data.production}}{{content.data.production}}{{/content.data.production}}{{^content.data.production}}-{{/content.data.production}} <span>tons</span></div> \
      </div> \
      <div class="insights--interactive-map-infowindow-data"> \
        <h3>Crop consumption</h3> \
        <div class="value">{{#content.data.consumption}}{{content.data.consumption}}{{/content.data.consumption}}{{^content.data.consumption}}-{{/content.data.consumption}} <span>tons</span></div> \
      </div> \
      <div class="insights--interactive-map-infowindow-data"> \
        <h3>Crop exports</h3> \
        <div class="value">{{#content.data.net_exports}}{{content.data.net_exports}}{{/content.data.net_exports}}{{^content.data.net_exports}}-{{/content.data.net_exports}} <span>tons</span></div> \
      </div> \
    </div>';

  var InteractiveMap = Backbone.View.extend({

    initialize: function() {
      this.$map = $('#js-map');
      this.$slider = $('#year-range');
      this.$switch = $('.onoffswitch');
      this.$container = $('.insights--interactive-map');

      this.fullscreenCount = 0;
      this.availableYears = [20, 30, 40];
      this.yearSelection = this.availableYears[0];
      this.scenario = 28;
      this.baseMaps = {
          "Basemap": L.tileLayer('https://a.tiles.mapbox.com/v4/smbtc.7d2e3bf9/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic21idGMiLCJhIjoiVXM4REppNCJ9.pjaLujYj-fcCPv5evG_0uA', {
              maxZoom: 18,
              zIndex: 0
          })
      };
      this.countryLayer = {
          user_name: 'insights',
          type: 'cartodb',
          sublayers: [{
              sql: 'SELECT * FROM countriedata',
              cartocss: '#countriedata{ polygon-fill: transparent; polygon-opacity: 0.7; line-color: #000000; line-width: 0.5; line-opacity: 0.1;}',
              interactivity: ['name', 'avg', 'prev_2020', 'net_exports', 'production', 'consumption']
          }]
      };

      this.renderSlider();
      this.renderMap();
      this.setListeners();
    },

    setListeners: function() {
      this.$switch.on('click', _.bind(this.toggleLayer, this));
      this.$slider.on('change', _.bind(this.setYear ,this));

      var fullscreenEvents = 'webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange';
      $(document).on(fullscreenEvents, _.bind(this.fullscreenWatcher, this));
    },

    getStressScenario: function(year, scenario) {
      return {
          user_name: 'insights',
          attribution: '| WRI Aqueduct, 2013. Siebert et al. 2013 Global Map of Irrigation Areas',
          type: 'cartodb',
          sublayers: [{
                sql: 'SELECT * FROM aqueduct_projections_20150309',
                cartocss: '#aqueduct_projections_20150309 {' +
                    'polygon-opacity:1;' +
                    'polygon-gamma:.2;' +
                    'polygon-fill: rgba(0,0,0,0);' +
                    '[ws' + year + scenario + 'cl="2.8x or greater decrease"] { polygon-fill:#0099cc; }' +
                    '[ws' + year + scenario + 'cl="2x decrease"]   { polygon-fill:#73afd1;  }' +
                    '[ws' + year + scenario + 'cl="1.4x decrease"] { polygon-fill:#abc7d9;  }' +
                    '[ws' + year + scenario + 'cl="Near normal"]   { polygon-fill:#7f8487; }' +
                    '[ws' + year + scenario + 'cl="1.4x increase"] { polygon-fill:#f8ab95;  }' +
                    '[ws' + year + scenario + 'cl="2x increase"]   { polygon-fill:#ff7351;  }' +
                    '[ws' + year + scenario + 'cl="2.8x or greater increase"] { polygon-fill:#ff1900; }}'
            },

            {
                sql: "select * from irrigation",
                cartocss: '#irrigation {raster-opacity:1; raster-colorizer-default-mode: discrete; raster-scaling:lanczos; raster-colorizer-stops: stop(2,rgba(255,255,255,0)) stop(10,rgba(255,255,255,1)) stop(50,rgba(255,255,255,1)) stop(255,rgba(255,255,255,1)); comp-op: dst-in;}',
                raster: true,
                raster_band: 1
            }
          ]
      };
    },

    renderMap: function() {
      if (!this.map) {
        this.map = L.map('js-map', {
          scrollWheelZoom: false,
          center: [8.928487062665504, 39.5947265625, ],
          zoom: 3,
          zoomControl: false,
          minZoom: 3,
          maxZoom: 6,
          layers: [this.baseMaps.Basemap]
        });

        L.control.zoom({
            position: 'topright'
        }).addTo(this.map);
      }

      if (!!this.layer) {
        this.map.removeLayer(this.layer);
      }

      if (!!this.infowindowLayer) {
        this.map.removeLayer(this.infowindowLayer);
      }

      if (!!this.infowindow) {
        this.infowindow.remove();
      }

      cartodb.createLayer(this.map, this.getStressScenario(this.yearSelection, this.scenario), { https: true }).done(_.bind(function(layer) {
        this.layer = layer;
        this.map.addLayer(layer);
      }, this));

      cartodb.createLayer(this.map, this.countryLayer, { https: true }).addTo(this.map).done(_.bind(function(layer) {
        this.infowindowLayer = layer;
        var subLayer = layer.getSubLayer(0);
        this.infowindow = cartodb.vis.Vis.addInfowindow(this.map, subLayer, this.countryLayer.sublayers[0].interactivity, {
            infowindowTemplate: (this.renderInfowindowTemplate)()
        });
      }, this));

      this.$switch.removeClass('off');
    },

    renderSlider: function() {
      this.$slider.prop({
        min: _.min(this.availableYears),
        max: _.max(this.availableYears),
        value: _.min(this.availableYears),
        step: 10
      });
    },

    setYear: function(e) {
      this.yearSelection = e.currentTarget.value;
      this.renderMap();
    },

    toggleLayer: function(e) {
      this.$switch.toggleClass('off');
      this.layer.toggle();
    },

    renderInfowindowTemplate: function() {
      return infowindowTPL.replace(/\%year\%/gi, '20' + this.yearSelection);
    },

    fullscreenWatcher: function() {
      var isEnteringFullscreen = this.fullscreenCount % 2 === 0;
      this.fullscreenCount++;

      if (isEnteringFullscreen && !fullscreen.isFullscreen()) {
          this.enableFullscreen();
      } else if (!isEnteringFullscreen && fullscreen.isFullscreen()) {
          this.disableFullscreen();
      }
    },

    enableFullscreen: function() {
      this.$container.css({
          width: '100%',
          height: '100%'
      });
    },

    disableFullscreen: function() {
      this.$container.attr('style', '');
    }

  });

  new InteractiveMap();

</script>
</body>
</html>
